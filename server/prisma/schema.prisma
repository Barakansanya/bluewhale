// BlueWhale Terminal - PostgreSQL Schema
// Production-ready schema for JSE small-cap research platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

enum UserRole {
  USER
  ANALYST
  ADMIN
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  role          UserRole @default(USER)
  
  // Subscription
  subscription  SubscriptionTier @default(FREE)
  stripeCustomerId String?
  subscriptionEndsAt DateTime?
  
  // Profile
  avatarUrl     String?
  company       String?
  jobTitle      String?
  
  // Relationships
  watchlists    Watchlist[]
  alerts        Alert[]
  reports       SavedReport[]
  apiKeys       ApiKey[]
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?
  
  @@index([email])
  @@index([subscription])
}

// ============================================
// COMPANIES & FINANCIAL DATA
// ============================================

enum Sector {
  FINANCIALS
  CONSUMER_GOODS
  INDUSTRIALS
  TECHNOLOGY
  HEALTHCARE
  TELECOMMUNICATIONS
  ENERGY
  MATERIALS
  UTILITIES
  REAL_ESTATE
  OTHER
}

model Company {
  id            String   @id @default(cuid())
  
  // Identifiers
  ticker        String   @unique
  name          String
  isin          String?  @unique
  jseCode       String?
  
  // Classification
  sector        Sector
  industry      String?
  marketCap     Decimal? @db.Decimal(15, 2)
  
  // Company Info
  description   String?  @db.Text
  website       String?
  logoUrl       String?
  
  // Trading Data
  lastPrice     Decimal? @db.Decimal(10, 2)
  priceChange   Decimal? @db.Decimal(10, 2)
  priceChangePercent Decimal? @db.Decimal(5, 2)
  volume        BigInt?
  
  // Status
  isActive      Boolean  @default(true)
  listedDate    DateTime?
  
  // Relationships
  financials    FinancialStatement[]
  metrics       CompanyMetrics[]
  reports       CompanyReport[]
  watchlists    WatchlistItem[]
  news          NewsArticle[]
  sentiments    SentimentAnalysis[]
  
  // Data source tracking
  dataSource    String?
  lastScrapedAt DateTime?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([ticker])
  @@index([sector])
  @@index([marketCap])
  @@index([isActive])
}

// ============================================
// FINANCIAL STATEMENTS & METRICS
// ============================================

enum StatementType {
  ANNUAL
  INTERIM
  QUARTERLY
}

model FinancialStatement {
  id            String   @id @default(cuid())
  
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Period
  fiscalYear    Int
  fiscalPeriod  String
  periodEnd     DateTime
  statementType StatementType
  
  // Income Statement
  revenue       Decimal? @db.Decimal(15, 2)
  costOfRevenue Decimal? @db.Decimal(15, 2)
  grossProfit   Decimal? @db.Decimal(15, 2)
  operatingExpenses Decimal? @db.Decimal(15, 2)
  ebitda        Decimal? @db.Decimal(15, 2)
  ebit          Decimal? @db.Decimal(15, 2)
  interestExpense Decimal? @db.Decimal(15, 2)
  taxExpense    Decimal? @db.Decimal(15, 2)
  netIncome     Decimal? @db.Decimal(15, 2)
  
  // Balance Sheet
  totalAssets   Decimal? @db.Decimal(15, 2)
  currentAssets Decimal? @db.Decimal(15, 2)
  totalLiabilities Decimal? @db.Decimal(15, 2)
  currentLiabilities Decimal? @db.Decimal(15, 2)
  totalEquity   Decimal? @db.Decimal(15, 2)
  cash          Decimal? @db.Decimal(15, 2)
  debt          Decimal? @db.Decimal(15, 2)
  
  // Cash Flow
  operatingCashFlow Decimal? @db.Decimal(15, 2)
  investingCashFlow Decimal? @db.Decimal(15, 2)
  financingCashFlow Decimal? @db.Decimal(15, 2)
  freeCashFlow  Decimal? @db.Decimal(15, 2)
  
  // Per Share Data
  eps           Decimal? @db.Decimal(10, 4)
  bvps          Decimal? @db.Decimal(10, 4)
  dividendPerShare Decimal? @db.Decimal(10, 4)
  
  // Metadata
  currency      String   @default("ZAR")
  sourceUrl     String?
  isAudited     Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([companyId, fiscalYear, statementType])
  @@index([companyId, fiscalYear])
  @@index([periodEnd])
}

model CompanyMetrics {
  id            String   @id @default(cuid())
  
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Valuation Ratios
  peRatio       Decimal? @db.Decimal(10, 2)
  pbRatio       Decimal? @db.Decimal(10, 2)
  psRatio       Decimal? @db.Decimal(10, 2)
  evToEbitda    Decimal? @db.Decimal(10, 2)
  
  // Profitability
  roe           Decimal? @db.Decimal(10, 2)
  roa           Decimal? @db.Decimal(10, 2)
  roic          Decimal? @db.Decimal(10, 2)
  grossMargin   Decimal? @db.Decimal(10, 2)
  operatingMargin Decimal? @db.Decimal(10, 2)
  netMargin     Decimal? @db.Decimal(10, 2)
  
  // Liquidity & Solvency
  currentRatio  Decimal? @db.Decimal(10, 2)
  quickRatio    Decimal? @db.Decimal(10, 2)
  debtToEquity  Decimal? @db.Decimal(10, 2)
  interestCoverage Decimal? @db.Decimal(10, 2)
  
  // Dividend
  dividendYield Decimal? @db.Decimal(5, 2)
  payoutRatio   Decimal? @db.Decimal(5, 2)
  
  // Growth (YoY)
  revenueGrowth Decimal? @db.Decimal(10, 2)
  epsGrowth     Decimal? @db.Decimal(10, 2)
  
  // Timestamp for this snapshot
  asOfDate      DateTime @default(now())
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([companyId, asOfDate])
  @@index([peRatio])
  @@index([dividendYield])
}

// ============================================
// REPORTS & DOCUMENTS
// ============================================

model CompanyReport {
  id            String   @id @default(cuid())
  
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  title         String
  reportType    String
  fiscalYear    Int?
  publishDate   DateTime
  
  // File info
  fileUrl       String?
  fileName      String?
  fileSize      Int?
  
  // AI Processing
  summary       String?  @db.Text
  keyPoints     String[]
  sentiment     String?
  aiProcessed   Boolean  @default(false)
  
  // Access
  savedBy       SavedReport[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([companyId, publishDate])
  @@index([reportType])
}

model SavedReport {
  id            String   @id @default(cuid())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  reportId      String
  report        CompanyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  notes         String?  @db.Text
  
  createdAt     DateTime @default(now())
  
  @@unique([userId, reportId])
  @@index([userId])
}

// ============================================
// WATCHLISTS
// ============================================

model Watchlist {
  id            String   @id @default(cuid())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name          String   @default("My Watchlist")
  description   String?
  isDefault     Boolean  @default(false)
  
  items         WatchlistItem[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
}

model WatchlistItem {
  id            String   @id @default(cuid())
  
  watchlistId   String
  watchlist     Watchlist @relation(fields: [watchlistId], references: [id], onDelete: Cascade)
  
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // User notes/targets
  targetPrice   Decimal? @db.Decimal(10, 2)
  notes         String?  @db.Text
  
  addedAt       DateTime @default(now())
  
  @@unique([watchlistId, companyId])
  @@index([watchlistId])
  @@index([companyId])
}

// ============================================
// ALERTS & NOTIFICATIONS
// ============================================

enum AlertType {
  PRICE_ABOVE
  PRICE_BELOW
  VOLUME_SPIKE
  NEW_REPORT
  EARNINGS_DATE
}

model Alert {
  id            String   @id @default(cuid())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId     String?
  
  type          AlertType
  threshold     Decimal? @db.Decimal(10, 2)
  message       String?
  
  isActive      Boolean  @default(true)
  triggered     Boolean  @default(false)
  triggeredAt   DateTime?
  
  createdAt     DateTime @default(now())
  
  @@index([userId, isActive])
  @@index([companyId])
}

// ============================================
// AI & SENTIMENT ANALYSIS
// ============================================

model SentimentAnalysis {
  id            String   @id @default(cuid())
  
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  source        String
  sourceUrl     String?
  
  sentiment     String
  score         Decimal  @db.Decimal(5, 2)
  
  summary       String?  @db.Text
  keywords      String[]
  
  analyzedAt    DateTime @default(now())
  
  @@index([companyId, analyzedAt])
  @@index([sentiment])
}

model NewsArticle {
  id            String   @id @default(cuid())
  
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  title         String
  summary       String?  @db.Text
  url           String
  source        String
  
  publishedAt   DateTime
  scrapedAt     DateTime @default(now())
  
  @@index([companyId, publishedAt])
}

// ============================================
// API ACCESS (Enterprise)
// ============================================

model ApiKey {
  id            String   @id @default(cuid())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  key           String   @unique
  name          String
  
  // Limits
  requestsPerDay Int     @default(1000)
  requestsUsedToday Int  @default(0)
  lastResetAt   DateTime @default(now())
  
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  expiresAt     DateTime?
  
  @@index([userId])
  @@index([key])
}

// ============================================
// SCRAPER METADATA
// ============================================

model ScraperJob {
  id            String   @id @default(cuid())
  
  jobType       String
  targetUrl     String
  
  status        String
  attempts      Int      @default(0)
  
  companyId     String?
  
  errorMessage  String?  @db.Text
  
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  
  @@index([status])
  @@index([jobType])
  @@index([createdAt])
}